<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Siane • Siane</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- Google Fonts --><link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&amp;family=Roboto:wght@100;300;400;500;700&amp;display=swap" rel="stylesheet">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- Hugo Universal --><link href="../style.violet.css" rel="stylesheet">
<!-- rOpenSpain --><link href="../ropenspain.css" rel="stylesheet">
<meta property="og:title" content="Siane">
<meta property="og:description" content="Siane">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed btn-template-main" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
      <span class="sr-only">Toggle navigation</span>
      <i class="fa fa-align-justify"></i>
      </button>
      <span class="navbar-brand" id="ROS-navbar-brand">
      <a class="navbar-link ROS-black" href="../index.html"><img src="../logo.png" alt="Siane-logo" id="ROS-navbar-logo">Siane</a> <span class="version label label-default hidden-xs" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/Siane.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
        
      </ul>
</div>  <!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->


      

      </header><script src="Siane_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Siane</h1>
                        <h4 class="author">Nuno Carvalho dos Santos</h4>
            
            <h4 class="date">2020-12-21</h4>
      
      
      <div class="hidden name"><code>Siane.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p><a href="https://github.com/Nuniemsis/Siane/">Siane</a> (El Sistema de Información del Atlas Nacional de España) is a project that supports technologically the publications and productions of the National Spanish Atlas(ANE). Recently, this project released CARTOSIANE, a set of maps compatible with the National Institute of Statistics georreferenced data(INE). The aim of this package is to create useful functions that plot INE’s georreferenced data on Siane map’s polygons.</p>
<p>Siane collects maps from five different scales(1:3M, 1:6.5M, 1:10M, 1:14M, 1:60M). The scope of this project covers the first two scales, i.e, 1:3M and 1:6.5M. The remaining scales represent the countries globally. We are not using those scales. This project focuses only in spanish maps.</p>
<p>Each set of maps is downloaded individually. <a href="https://github.com/Nuniemsis/Siane/">The README.md</a> file has very detailed information about the downloading process.</p>
<pre><code>SIANE_CARTO_BASE_E_14M.ZIP  
SIANE_CARTO_BASE_S_10M.ZIP        
SIANE_CARTO_BASE_S_3M.ZIP
SIANE_CARTO_BASE_S_6M5.ZIP
SIANE_CARTO_BASE_W_60M.ZIP  </code></pre>
<p>This package needs SIANE_CARTO_BASE_S_3M.ZIP and SIANE_CARTO_BASE_S_6M5.ZIP files.</p>
<p>In this document I will describe and make use of the main functions of this package. The first step is to load the package. Uncomment the first two code lines in case you haven’t installed the package yet.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#library(devtools)</span>
<span class="co">#install_github("Nuniemsis/Siane")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">Siane</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pxR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></code></pre></div>
</div>
<div id="setting-the-path-of-the-maps" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-the-path-of-the-maps" class="anchor"></a>Setting the path of the maps</h2>
<p>As I already explained, Siane consists of a collection of maps. This package needs to locate the path of this collection(folder) in order to search the requested map.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/register_siane.html">register_siane</a></span><span class="op">(</span><span class="st">"/home/ncarvalho/Descargas/"</span><span class="op">)</span></code></pre></div>
</div>
<div id="loading-a-map" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-a-map" class="anchor"></a>Loading a map</h2>
<p>Once we have located all the maps we can select one according with our data. These parameters are enough to specify a map.<br>
- <code>year</code> : Maps can change over time. This numerical parameter is the year of the map we want.<br>
- <code>canarias</code> : It indicates whether we want to plot Canarias or not. - <code>level</code> : It’s the administrative level. For this set of maps there are three: “Municipios”, “Provincias” and “Comunidades”<br>
- <code>scale</code> : The scale of the maps. The default scale for municipalities is 1:3000000 <code>scale &lt;- "3m"</code>. For provinces and regions the default scale is 1:6500000 <code>scale &lt;- "6m"</code>.<br>
- <code>peninsula</code>: It’s the relative position of the Canarias island to the peninsulae.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">level</span> <span class="op">&lt;-</span> <span class="st">"Municipios"</span>
<span class="va">canarias</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
<span class="va">year</span> <span class="op">&lt;-</span> <span class="fl">2016</span>
<span class="va">scale</span> <span class="op">&lt;-</span> <span class="st">"3m"</span>
<span class="va">peninsula</span> <span class="op">&lt;-</span> <span class="st">"close"</span></code></pre></div>
<p>Now we call the <code>siane_map</code> function to extract a map from all the map’s collection.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/siane_map.html">siane_map</a></span><span class="op">(</span>level <span class="op">=</span> <span class="va">level</span>, obj <span class="op">=</span> <span class="va">obj</span>, canarias <span class="op">=</span> <span class="va">canarias</span>, year <span class="op">=</span> <span class="va">year</span>, scale <span class="op">=</span> <span class="va">scale</span>, peninsula <span class="op">=</span> <span class="va">peninsula</span><span class="op">)</span> <span class="co"># Reading the map from the maps collection</span></code></pre></div>
</div>
<div id="plot-the-map" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-the-map" class="anchor"></a>Plot the map</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span></code></pre></div>
<p>This function also allows the user to change the position of Canarias islands through the peninsula parameter.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">peninsula</span> <span class="op">&lt;-</span> <span class="st">"far"</span>

<span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/siane_map.html">siane_map</a></span><span class="op">(</span>level <span class="op">=</span> <span class="va">level</span>, obj <span class="op">=</span> <span class="va">obj</span>, canarias <span class="op">=</span> <span class="va">canarias</span>, year <span class="op">=</span> <span class="va">year</span>, scale <span class="op">=</span> <span class="va">scale</span>, peninsula <span class="op">=</span> <span class="va">peninsula</span><span class="op">)</span> <span class="co"># Reading the map from the maps collection</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span></code></pre></div>
<p>The spanish political map looks just like this. Let’s try to plot some data on it. To keep following this tutorial you should download previously the data from the INE website. The README.md file explains how to download it. I will also share the <a href="http://www.ine.es/jaxiT3/Tabla.htm?t=2879">link</a> here in case you already now how to do it.</p>
</div>
<div id="polygon-colour-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#polygon-colour-plot" class="anchor"></a>Polygon colour plot</h2>
<div id="data-frame-reading" class="section level4">
<h4 class="hasAnchor">
<a href="#data-frame-reading" class="anchor"></a>Data frame reading</h4>
<p>Let’s explore the dataset before plotting the data</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">read.px</span><span class="op">(</span><span class="st">"/home/ncarvalho/Descargas/2879.px"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="co"># List the column names  of the data frame</span></code></pre></div>
</div>
<div id="data-frame-filtering" class="section level4">
<h4 class="hasAnchor">
<a href="#data-frame-filtering" class="anchor"></a>Data frame filtering</h4>
<p>First we need to understand the data frame. It’s columns are the following:<br>
- <code>Periodo</code> is the time column in year’s format.<br>
- <code>value</code> is a column with the numeric value of the population.<br>
- <code>Sexo</code> is the sex of that population.<br>
- <code>Municipios</code> is a character array with the municipality name and the municipality code In this dataset there is only one value per territory.</p>
<p>Split the <code>Municipios</code> column to get the municipality’s codes.<br>
We are storing these codes in the column <code>codes</code>. This column is really important in order to plot the polygons with the corresponding colour colours.</p>
</div>
<div id="data-frame-preparation" class="section level4">
<h4 class="hasAnchor">
<a href="#data-frame-preparation" class="anchor"></a>Data frame preparation</h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">by</span> <span class="op">&lt;-</span> <span class="st">"codes"</span></code></pre></div>
<p>We create a single column in the data frame with those codes.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span><span class="op">[[</span><span class="va">by</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Municipios</span>,
                   <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, split <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span><span class="op">$</span><span class="va">Periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Periodo</span><span class="op">)</span><span class="op">)</span> <span class="co"># Convert factor to numeric</span></code></pre></div>
<p>Plotting polygons by colour intensity requires one unique value per territory. Therefore, we have to filter the data frame.<br><strong>Remember</strong>: One value per territory.<br>
In this example I want to plot the total population in the year 2016.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">Sex</span> <span class="op">==</span> <span class="st">"Total"</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">Periodo</span> <span class="op">==</span> <span class="va">year</span>, <span class="op">]</span></code></pre></div>
<p>The <code>siane_merge</code> function assigns each polygon a value. Those values are stored in a column of <code>shp_merged@data</code> which name can be chosen by the user changing the <code>value</code> variable.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">by</span> <span class="op">&lt;-</span> <span class="st">"codes"</span> <span class="co"># name for the codes column</span>
<span class="va">value</span> <span class="op">&lt;-</span> <span class="st">"value"</span> <span class="co"># name for the values column</span>

<span class="va">shp_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/siane_merge.html">siane_merge</a></span><span class="op">(</span>shp <span class="op">=</span> <span class="va">shp</span>, df <span class="op">=</span> <span class="va">df</span>,by <span class="op">=</span> <span class="va">by</span>, level <span class="op">=</span> <span class="va">level</span>, value <span class="op">=</span> <span class="va">value</span><span class="op">)</span></code></pre></div>
<p>We can plot the map with the statistical data with the <code>plot</code> function. The <code>RColorBrewer</code> package provides lots of colour scales. We can use this colour scales to visualize data over the map. The following function displays all the colour scales from that package.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">display.brewer.all</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Match each number with its corresponding interval to be able to decide its colour.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">col</span> <span class="op">&lt;-</span> <span class="va">colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/findInterval.html">findInterval</a></span><span class="op">(</span><span class="va">values_ine</span>, <span class="va">my_pallete</span>,
                           all.inside<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span> <span class="co"># Setting the final colors</span></code></pre></div>
<p>In case we want to plot the population of certain municipalities in a province, we must use a sequential pallete.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pallete_colour</span> <span class="op">&lt;-</span> <span class="st">"OrRd"</span> <span class="co"># Scale of oranges and reds</span></code></pre></div>
<p>Let’s say that <code>n</code> is the number of colour intervals.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">5</span></code></pre></div>
<p>The brewer.pal function builds a pallete with <code>n</code> intervals and the <code>pallete_colour</code> colour.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">values_ine</span> <span class="op">&lt;-</span> <span class="va">shp_merged</span><span class="op">@</span><span class="va">data</span><span class="op">[[</span><span class="va">value</span><span class="op">]</span><span class="op">]</span> <span class="co"># Values we want to plot are stored in the shape@data data frame</span>
<span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu">brewer.pal</span><span class="op">(</span><span class="va">n</span>, <span class="va">pallete_colour</span><span class="op">)</span> <span class="co"># A pallete from RColorBrewer </span></code></pre></div>
<p>The style is the distribution of the colour within data. The <code>classIntervals</code> function generates numerical intervals. The upper and lower limits of these intervals are named breaks.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">style</span> <span class="op">&lt;-</span> <span class="st">"quantile"</span> 
<span class="va">brks</span> <span class="op">&lt;-</span> <span class="fu">classIntervals</span><span class="op">(</span><span class="va">values_ine</span>, n <span class="op">=</span> <span class="va">n</span>, style <span class="op">=</span> <span class="va">style</span><span class="op">)</span>
<span class="va">my_pallete</span> <span class="op">&lt;-</span> <span class="va">brks</span><span class="op">$</span><span class="va">brks</span> <span class="co"># my pallete contains the breaks</span></code></pre></div>
<p>Plot the map and set title and legends.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">shp_merged</span>,col <span class="op">=</span> <span class="va">col</span><span class="op">)</span> <span class="co"># Plot the map</span>
<span class="va">title_plot</span> <span class="op">&lt;-</span> <span class="st">"Población total por municipios en La Rioja"</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">title_plot</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span>legend <span class="op">=</span> <span class="fu">leglabs</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">my_pallete</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">colors</span>,x <span class="op">=</span> <span class="st">"bottomright"</span><span class="op">)</span></code></pre></div>
</div>
<div id="other-examples" class="section level4">
<h4 class="hasAnchor">
<a href="#other-examples" class="anchor"></a>Other examples</h4>
<p>Let’s try to plot data at a different administrative level. The next dataset collects the spanish population for all the provinces in a specific range of years. You can find the link in the README.MD file as well. <a href="http://www.ine.es/jaxiT3/Tabla.htm?t=2852&amp;L=0">Link here</a></p>
<p>The process is almost the same as the previous one.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">read.px</span><span class="op">(</span><span class="st">"/home/ncarvalho/Descargas/2852.px"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="co"># List the column names  of the data frame</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span><span class="op">[[</span><span class="va">by</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Provincias</span>,
                   <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, split <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span><span class="op">$</span><span class="va">Periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Periodo</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">Sex</span> <span class="op">==</span> <span class="st">"Total"</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">Periodo</span> <span class="op">==</span> <span class="va">year</span>,<span class="op">]</span></code></pre></div>
<p>Remember that first we have to create the shapefile. We can’t use the previous shapefile provided that the level is not the same.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">level</span> <span class="op">&lt;-</span> <span class="st">"Provincias"</span>
<span class="va">canarias</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="va">year</span> <span class="op">&lt;-</span> <span class="fl">2016</span>
<span class="va">scale</span> <span class="op">&lt;-</span> <span class="st">"6m"</span></code></pre></div>
<p>Generate the map again.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/siane_map.html">siane_map</a></span><span class="op">(</span>obj <span class="op">=</span> <span class="va">obj</span>, canarias <span class="op">=</span> <span class="va">canarias</span>, year <span class="op">=</span> <span class="va">year</span>, level <span class="op">=</span> <span class="va">level</span>, scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">value</span> <span class="op">&lt;-</span> <span class="st">"value"</span>
<span class="va">by</span> <span class="op">&lt;-</span> <span class="st">"codes"</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">shp_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/siane_merge.html">siane_merge</a></span><span class="op">(</span>shp <span class="op">=</span> <span class="va">shp</span>, df <span class="op">=</span> <span class="va">df</span>, by <span class="op">=</span> <span class="va">by</span>, level <span class="op">=</span> <span class="va">level</span>, value <span class="op">=</span> <span class="va">value</span><span class="op">)</span></code></pre></div>
</div>
<div id="plot-the-map-" class="section level4">
<h4 class="hasAnchor">
<a href="#plot-the-map-" class="anchor"></a>Plot the map.</h4>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pallete_colour</span> <span class="op">&lt;-</span> <span class="st">"BuPu"</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">7</span>
<span class="va">style</span> <span class="op">&lt;-</span> <span class="st">"kmeans"</span>


<span class="va">values_ine</span> <span class="op">&lt;-</span> <span class="va">shp_merged</span><span class="op">@</span><span class="va">data</span><span class="op">[[</span><span class="va">value</span><span class="op">]</span><span class="op">]</span> <span class="co"># Values we want to plot are stored in the shape@data data frame</span>
<span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu">brewer.pal</span><span class="op">(</span><span class="va">n</span>, <span class="va">pallete_colour</span><span class="op">)</span> <span class="co"># A pallete from RColorBrewer </span>


<span class="va">brks</span> <span class="op">&lt;-</span> <span class="fu">classIntervals</span><span class="op">(</span><span class="va">values_ine</span>, n <span class="op">=</span> <span class="va">n</span>, style <span class="op">=</span> <span class="va">style</span><span class="op">)</span>
<span class="va">my_pallete</span> <span class="op">&lt;-</span> <span class="va">brks</span><span class="op">$</span><span class="va">brks</span>


<span class="va">col</span> <span class="op">&lt;-</span> <span class="va">colors</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/findInterval.html">findInterval</a></span><span class="op">(</span><span class="va">values_ine</span>, <span class="va">my_pallete</span>,
                           all.inside<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span> <span class="co"># Setting the final colors</span>


<span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">shp_merged</span>,col <span class="op">=</span> <span class="va">col</span><span class="op">)</span> <span class="co"># Plot the map</span>

<span class="va">title_plot</span> <span class="op">&lt;-</span> <span class="st">"Población de España a nivel de provincias"</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">title_plot</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span>legend <span class="op">=</span> <span class="fu">leglabs</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">my_pallete</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">colors</span>,x <span class="op">=</span> <span class="st">"bottomright"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="combining-siane-with-other-libraries" class="section level2">
<h2 class="hasAnchor">
<a href="#combining-siane-with-other-libraries" class="anchor"></a>Combining Siane with other libraries</h2>
<p>Please download this data <a href="http://www.ine.es/jaxi/Tabla.htm?path=/t20/e245/p05/a2002/l0/&amp;file=00008001.px&amp;L=0">link</a>. This dataset contains the number of inhabitants of Barcelona’s municipalities per five year age groups. We are now trying to combine leaflet library with Siane to make a higher quality visualization. In this visualization I will plot the percentage of girls whose ages are in the range of 0-4 years.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">leaflet</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">data.table</span><span class="op">)</span></code></pre></div>
<p>Reading the map</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/siane_map.html">siane_map</a></span><span class="op">(</span>obj <span class="op">=</span> <span class="va">obj</span>, canarias <span class="op">=</span> <span class="cn">FALSE</span>, year <span class="op">=</span> <span class="fl">2016</span>,level <span class="op">=</span> <span class="st">"Municipios"</span> ,scale <span class="op">=</span> <span class="st">"3m"</span><span class="op">)</span></code></pre></div>
<p>Reading the data</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">read.px</span><span class="op">(</span><span class="st">"/home/ncarvalho/Descargas/00008001.px"</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">as.data.table</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></code></pre></div>
<p>Calculating the sum of the inhabitants of all ages per sex.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_sum</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Municipios"</span>, <span class="st">"Sexo"</span><span class="op">)</span> <span class="op">]</span></code></pre></div>
<p>Calculating the percentage of each group of age per municipality and gender</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_withsums</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df_sum</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Municipios"</span>,<span class="st">"Sexo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">df_withsums</span><span class="op">$</span><span class="va">perc</span> <span class="op">&lt;-</span> <span class="va">df_withsums</span><span class="op">$</span><span class="va">value</span><span class="op">/</span><span class="va">df_withsums</span><span class="op">$</span><span class="va">V1</span><span class="op">*</span><span class="fl">100</span></code></pre></div>
<p>Filtering the data: Women with 0-4 years old.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_withsums</span> <span class="op">&lt;-</span> <span class="va">df_withsums</span><span class="op">[</span><span class="va">df_withsums</span><span class="op">$</span><span class="va">Sexo</span><span class="op">==</span><span class="st">"Mujeres"</span><span class="op">&amp;</span>
                           <span class="va">df_withsums</span><span class="op">$</span><span class="va">Edad..grupos.quinquenales.</span><span class="op">==</span><span class="st">"0-4"</span><span class="op">]</span></code></pre></div>
<p>Extracting the territory code for all the municipalities</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">by</span> <span class="op">&lt;-</span> <span class="st">"codes"</span>
<span class="va">value</span> <span class="op">&lt;-</span> <span class="st">"perc"</span>

<span class="va">df_withsums</span><span class="op">[[</span><span class="va">by</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">df_withsums</span><span class="op">$</span><span class="va">Municipios</span>,
                   <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, split <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p>Merging spatial data and statistical data.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">shp_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/siane_merge.html">siane_merge</a></span><span class="op">(</span>shp <span class="op">=</span> <span class="va">shp</span>, df <span class="op">=</span> <span class="va">df_withsums</span>, by <span class="op">=</span> <span class="va">by</span>,value <span class="op">=</span> <span class="va">value</span>, level <span class="op">=</span> <span class="st">"Municipios"</span><span class="op">)</span></code></pre></div>
<p>Plot the data</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu">colorNumeric</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"YlOrRd"</span>, domain <span class="op">=</span> <span class="va">shp_merged</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">perc</span><span class="op">)</span>

<span class="fu">leaflet</span><span class="op">(</span><span class="va">shp_merged</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># </span>
  <span class="fu">addTiles</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>    <span class="co"># Add the world map </span>
  <span class="fu">addPolygons</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#444444"</span>, weight <span class="op">=</span> <span class="fl">1</span>, smoothFactor <span class="op">=</span> <span class="fl">0.5</span>,  <span class="co"># options</span>
    opacity <span class="op">=</span> <span class="fl">1.0</span>, fillOpacity <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># options</span>
    fillColor <span class="op">=</span> <span class="op">~</span><span class="fu">colorQuantile</span><span class="op">(</span><span class="st">"YlOrRd"</span>, <span class="va">perc</span><span class="op">)</span><span class="op">(</span><span class="va">perc</span><span class="op">)</span>, <span class="co"># Choose the scale, Choose the column to plot</span>
    highlightOptions <span class="op">=</span> <span class="fu">highlightOptions</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, weight <span class="op">=</span> <span class="fl">2</span>, <span class="co"># options</span>
      bringToFront <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span><span class="co"># options</span>

  <span class="fu">addLegend</span><span class="op">(</span><span class="st">"bottomright"</span>, pal <span class="op">=</span> <span class="va">pal</span>, values <span class="op">=</span> <span class="va">shp_merged</span><span class="op">$</span><span class="va">perc</span> , title <span class="op">=</span> <span class="st">"Porcentaje de mujeres con 0-4 anyos"</span>, opacity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>This leaflet documentation is available <a href="https://rstudio.github.io/leaflet/shapes.html">here</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>




      <footer id="footer"><div class="container">
		<div class="col-md-3 col-sm-6 col-md-offset-1">
			<h4 data-toc-skip>About Siane</h4>
			Developed by <a href="http://www.datanalytics.com/">Carlos J. Gil Bellosta</a>, <a href="https://github.com/Nuniemsis">Nuno Carvalho</a>, part of the <span class="ROS-light">rOpenSpain</span> project.
			<hr class="hidden-md hidden-lg hidden-sm">
</div>
		<div class="col-md-3 col-sm-6 col-md-offset-4">
			<h4 data-toc-skip>About <img src="../ROS-logo.png" alt="ROpenSpain Logo" height="24"><span class="ROS-light"> rOpenSpain</span>
</h4>
			<a href="https://ropenspain.es/"><span class="ROS-light">rOpenSpain</span></a> is a community of R enthusiasts whose ultimate goal is to create high-quality R packages for data mining public spanish open sources.
			<hr class="hidden-md hidden-lg hidden-sm">
</div>
	</div>
</footer><div id="copyright">
	<div class="container">
		<div class="col-md-12">
			<p class="pull-left">
			Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.
			</p>
			<p class="pull-right">
			Template by <a href="https://bootstrapious.com/snippets">Bootstrapious </a>.
			Ported to pkgdown by <a href="https://github.com/dieghernan/">dieghernan</a>.
			</p>
		</div>
	</div>
</div>

<!-- ropenspain -->
<script src="../ropenspain.js"></script>
</div>
   
  


  </body>
</html>
